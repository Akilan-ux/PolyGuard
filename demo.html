<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PolyGuard Demo — Registration, Authentication, Proof of Transaction</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        /* Small overrides for demo page */
        .demo-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 24px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
        }

        .demo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--border-gray);
            padding-bottom: 12px;
            margin-bottom: 18px;
        }

        .tab-btn {
            background: transparent;
            padding: 10px 16px;
            border-radius: 8px 8px 0 0;
            border: 1px solid transparent;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .tab-btn[aria-selected="true"] {
            background: var(--white);
            border-color: var(--border-gray);
            border-bottom-color: var(--white);
            color: var(--primary-blue);
            box-shadow: 0 -3px 12px rgba(0,82,204,0.08);
        }

        .tab-panel {
            display: none;
            padding: 18px 6px;
        }

        .tab-panel.active {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row .full {
            grid-column: 1 / -1;
        }

        input[type="text"], input[type="email"], textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
        }

        .result-box {
            padding: 14px;
            border-radius: 8px;
            background: var(--light-gray);
            border: 1px solid var(--border-gray);
            margin-top: 12px;
            font-size: 14px;
        }

        .back-link { color: var(--medium-gray); font-size: 14px; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-container container">
            <div class="navbar-brand"><h1>PolyGuard</h1></div>
            <nav class="navbar-menu">
                <a href="main.html" class="nav-link back-link">← Back to Home</a>
            </nav>
        </div>
    </header>

    <main class="demo-container">
        <div class="demo-header">
            <div>
                <h2 style="margin-bottom:6px;">PolyGuard Interactive Demo</h2>
                <p style="margin:0; color:var(--medium-gray);">Try out registration, authentication, and transaction proofs.</p>
            </div>
            <div>
                <a class="nav-demo-btn btn-tier-secondary" href="#">Request Live Demo</a>
            </div>
        </div>

        <div role="tablist" aria-label="Demo Tabs" class="tabs" id="demoTabs">
            <button role="tab" aria-selected="true" aria-controls="panel-register" id="tab-register" class="tab-btn">Registration</button>
            <button role="tab" aria-selected="false" aria-controls="panel-auth" id="tab-auth" class="tab-btn">Authentication</button>
            <button role="tab" aria-selected="false" aria-controls="panel-proof" id="tab-proof" class="tab-btn">Proof of Transaction</button>
        </div>

        <section id="panel-register" role="tabpanel" aria-labelledby="tab-register" class="tab-panel active">
            <h3>Registration</h3>
            <p style="color:var(--medium-gray)">Sign up with your business details (1-2 working days for verification).</p>
            <form id="registerForm">
                <div style="margin-bottom:14px;">
                    <label style="display:inline-block; width:120px; font-weight:500; color:var(--dark-gray);">Full Name:</label>
                    <input type="text" name="fullName" style="width:300px;" required />
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:inline-block; width:120px; font-weight:500; color:var(--dark-gray);">Company:</label>
                    <input type="text" name="company" style="width:300px;" />
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:inline-block; width:120px; font-weight:500; color:var(--dark-gray);">Work Email:</label>
                    <input type="email" name="email" style="width:300px;" required />
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:inline-block; width:120px; font-weight:500; color:var(--dark-gray);">Phone:</label>
                    <input type="text" name="phone" style="width:300px;" placeholder="(optional)" />
                </div>
                
                <div style="display:flex; gap:12px; margin-top:20px;">
                    <button type="submit" class="btn btn-primary">Generate Hash ID</button>
                    <button type="button" id="regReset" class="btn btn-tier-secondary">Reset</button>
                </div>
                <div id="regResult" class="result-box" style="display:none"></div>
            </form>
        </section>

        <section id="panel-auth" role="tabpanel" aria-labelledby="tab-auth" class="tab-panel">
            <h3>Scan & Authenticate</h3>
            <p style="color:var(--medium-gray)">Scan a QR code to verify the transaction.</p>
            
            <div style="margin-bottom: 20px;">
                <button id="startScanner" class="btn btn-primary">Start Camera</button>
                <button id="stopScanner" class="btn btn-tier-secondary" style="display: none;">Stop Camera</button>
            </div>

            <div id="scannerContainer" style="display: none; text-align: center; margin: 20px 0;">
                <canvas id="scanner-canvas" style="border: 2px solid #0052CC; border-radius: 8px; max-width: 400px; width: 100%;"></canvas>
                <p style="color: #666; font-size: 12px; margin-top: 10px;">Point your camera at the QR code</p>
            </div>

            <div id="scanResult"></div>
        </section>

        <section id="panel-proof" role="tabpanel" aria-labelledby="tab-proof" class="tab-panel">
            <h3>Transaction History</h3>
            <p style="color:var(--medium-gray)">Enter a transaction ID to verify an immutable proof on-chain (Ethereum).</p>
            <div style="margin-bottom:14px;">
                <label style="display:inline-block; width:120px; font-weight:500; color:var(--dark-gray);">Transaction ID:</label>
                <input type="text" id="txId" style="width:300px;" placeholder="e.g. tx_0x123abc..." />
            </div>
            <div style="display:flex; gap:12px; margin-top:8px;">
                <button id="proofBtn" class="btn btn-primary">Verify Transaction</button>
                <button id="proofSample" class="btn btn-tier-secondary">Use Sample TX</button>
            </div>
            <div id="proofResult" class="result-box" style="display:none"></div>
        </section>

    </main>

    <script>
        // Tab switching logic
        (function() {
            const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
            const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

            function activateTab(tab) {
                tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
                tab.setAttribute('aria-selected', 'true');
                panels.forEach(p => p.classList.remove('active'));
                const panel = document.getElementById(tab.getAttribute('aria-controls'));
                if (panel) panel.classList.add('active');
                tab.focus();
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => activateTab(tab));
                tab.addEventListener('keydown', (e) => {
                    const i = tabs.indexOf(tab);
                    if (e.key === 'ArrowRight') activateTab(tabs[(i + 1) % tabs.length]);
                    if (e.key === 'ArrowLeft') activateTab(tabs[(i - 1 + tabs.length) % tabs.length]);
                });
            });
        })();

        // Registration form - send company name as product_id to local hash API
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            const name = data.get('fullName');
            const email = data.get('email');
            const company = (data.get('company') || '').trim();
            const result = document.getElementById('regResult');
            result.style.display = 'block';

            if (!company) {
                result.innerHTML = '<strong>Error:</strong> Company name is required to generate product id.';
                result.style.borderColor = 'var(--red)';
                return;
            }

            // POST to hash endpoint (local server)
            try {
                const res = await fetch('/hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: company })
                });

                if (!res.ok) throw new Error('Network response was not ok');
                const json = await res.json();
                const sha = json.sha256;
                result.style.borderColor = 'var(--green)';
                result.innerHTML = `<strong>Success:</strong> Hash QR code created for <strong>${escapeHtml(name)}</strong> (${escapeHtml(email)}).<br>Product ID (company): <code>${escapeHtml(company)}</code><br>SHA-256: <code>${sha}</code>`;
                        // Show deploy subsection asking whether to deploy to private blockchain
                        showDeploySubsection(sha, name, email, company);
            } catch (err) {
                result.style.borderColor = 'var(--red)';
                result.innerHTML = `<strong>Error:</strong> Could not reach local hash API. Make sure the server is running</strong>`;
            }
        });

        document.getElementById('regReset').addEventListener('click', function() {
            document.getElementById('registerForm').reset();
            const result = document.getElementById('regResult');
            result.style.display = 'none';
            result.innerHTML = '';
        });

        // QR Scanner for Authentication tab
        let cameraStream = null;
        let scanningActive = false;

        document.getElementById('startScanner').addEventListener('click', async () => {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.createElement('video');
                video.srcObject = cameraStream;
                video.setAttribute('playsinline', true);
                video.setAttribute('autoplay', true);
                video.play();

                document.getElementById('scannerContainer').style.display = 'block';
                document.getElementById('startScanner').style.display = 'none';
                document.getElementById('stopScanner').style.display = 'inline-block';

                scanningActive = true;
                scanQRCode(video);
            } catch (err) {
                alert('Camera access denied or unavailable: ' + err.message);
            }
        });

        document.getElementById('stopScanner').addEventListener('click', () => {
            scanningActive = false;
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('scannerContainer').style.display = 'none';
            document.getElementById('startScanner').style.display = 'inline-block';
            document.getElementById('stopScanner').style.display = 'none';
            document.getElementById('scanResult').innerHTML = '';
        });

        function scanQRCode(video) {
            const canvas = document.getElementById('scanner-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 320;
            canvas.height = 240;

            const scanFrame = () => {
                if (!scanningActive) return;

                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                try {
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        scanningActive = false;
                        handleQRCode(code.data);
                        document.getElementById('stopScanner').click();
                        return;
                    }
                } catch (e) {
                    // Continue scanning
                }

                requestAnimationFrame(scanFrame);
            };

            scanFrame();
        }

        async function handleQRCode(qrData) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.innerHTML = '<p style="color: #0052CC; margin-top: 20px;">Verifying QR code...</p>';

            try {
                const resp = await fetch('/qr-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hash: qrData })
                });
                const json = await resp.json();

                if (json.verified && json.company) {
                    resultDiv.innerHTML = `
                        <div class="result-box" style="border-left: 4px solid #4CAF50; background: #F0F8F0; margin-top: 20px;">
                            <strong style="color: #4CAF50;">✓ Verified</strong><br>
                            Company: ${escapeHtml(json.company)}<br>
                            Email: ${escapeHtml(json.email)}<br>
                            Name: ${escapeHtml(json.full_name)}<br>
                            Registered: ${new Date(json.created_at).toLocaleString()}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="result-box" style="border-left: 4px solid #f44336; background: #FFEBEE; margin-top: 20px;"><strong style="color: #f44336;">✗ QR Not Found</strong></div>';
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="result-box" style="border-left: 4px solid #f44336; background: #FFEBEE; margin-top: 20px;"><strong style="color: #f44336;">Error:</strong> ${escapeHtml(err.message)}</div>`;
            }
        }

        // Proof of Transaction simulation
        document.getElementById('proofBtn').addEventListener('click', function() {
            const tx = document.getElementById('txId').value.trim();
            const r = document.getElementById('proofResult');
            r.style.display = 'block';
            if (!tx) { r.innerHTML = '<strong>Error:</strong> Transaction ID required.'; r.style.borderColor = 'var(--red)'; return; }
            // Simulate lookup
            const exists = Math.random() > 0.08;
            if (exists) {
                r.innerHTML = `<strong>Verified:</strong> Transaction <code>${escapeHtml(tx)}</code> was recorded on-chain. Merkle proof: <code>0x${Math.random().toString(16).slice(2,20)}</code>`;
                r.style.borderColor = 'var(--green)';
            } else {
                r.innerHTML = `<strong>Not found:</strong> No immutable proof found for <code>${escapeHtml(tx)}</code>.`;
                r.style.borderColor = 'var(--red)';
            }
        });

        document.getElementById('proofSample').addEventListener('click', function() {
            document.getElementById('txId').value = 'tx_demo_0x' + Math.random().toString(16).slice(2,12);
            document.getElementById('proofBtn').click();
        });

        // small helper to escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]; });
        }
        // --- Deploy subsection logic ---
        function showDeploySubsection(sha, fullName, email, company) {
            // Remove existing if present
            let el = document.getElementById('deploySub');
            if (el) el.remove();

            const container = document.createElement('div');
            container.id = 'deploySub';
            container.style.marginTop = '18px';
            container.innerHTML = `
                <h4>Deploy Hash to Private Blockchain?</h4>
                <p style="color:var(--medium-gray)">Would you like to deploy this product hash to a local private blockchain for verification and proof? This will require running a local Hardhat node (no real gas fees) and deploying a small registry contract. If you choose <strong>Yes</strong>, follow the quick commands provided below.</p>
                <div style="display:flex; gap:12px; margin-bottom:12px;">
                    <button id="deployYes" class="btn btn-primary">Yes — show commands</button>
                    <button id="deployNo" class="btn btn-tier-secondary">No, thanks</button>
                </div>
                <div id="deployInstructions" style="display:none; margin-top:12px; background:var(--light-gray); padding:12px; border-radius:8px; border:1px solid var(--border-gray);">
                    <p style="margin:0 0 8px 0;"><strong>Deploy & Generate QR</strong></p>          
                    <p style="color:var(--medium-gray)">Press Deploy Now to register your hash on the blockchain and generate a QR code. This QR code can then be used for transactions and scanned by your customers.</p>
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button id="deployNow" class="btn btn-primary">Deploy Now & Generate QR</button>
                    </div>
                    <p style="margin-top:8px; color:var(--medium-gray); font-size:13px;">Note: The blockchain for PolyGuard is configured for zero gas price locally.</p>
                </div>
                <div id="qrResult" style="display:none; margin-top:12px; padding:12px; border-radius:8px; background:var(--light-blue); border:1px solid var(--primary-blue); text-align:center;">
                    <p style="margin:0 0 12px 0;"><strong>✓ QR Code Generated & Stored</strong></p>
                    <img id="qrImage" style="max-width:300px; border:2px solid var(--primary-blue); border-radius:8px;" />
                    <p style="margin:12px 0 0 0; font-size:13px; color:var(--medium-gray);">Scan this QR code with your phone on the Authentication tab</p>
                </div>
            `;

            const parent = document.getElementById('registerForm');
            parent.parentNode.insertBefore(container, parent.nextSibling);

            document.getElementById('deployYes').addEventListener('click', () => {
                document.getElementById('deployInstructions').style.display = 'block';
            });
            document.getElementById('deployNo').addEventListener('click', () => {
                container.remove();
            });
            document.getElementById('copyCmd').addEventListener('click', async () => {
                const text = document.getElementById('deployCmd').innerText;
                try { await navigator.clipboard.writeText(text); alert('Commands copied to clipboard'); } catch(e) { alert('Copy not available: ' + e.message); }
            });
            document.getElementById('deployNow').addEventListener('click', async () => {
                const btn = document.getElementById('deployNow');
                btn.disabled = true;
                btn.textContent = 'Generating QR...';

                try {
                    const resp = await fetch('/qr-store', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hash: sha, company, email, fullName })
                    });
                    const json = await resp.json();
                    if (!resp.ok) {
                        alert(`Error: ${json.error || 'Failed to store QR'}`);
                        btn.disabled = false;
                        btn.textContent = 'Deploy Now & Generate QR';
                        return;
                    }

                    // Display QR code
                    document.getElementById('qrImage').src = json.qrCode;
                    document.getElementById('qrResult').style.display = 'block';
                    btn.textContent = 'QR Generated & Stored';
                } catch (err) {
                    alert(`Error: ${err.message}`);
                    btn.disabled = false;
                    btn.textContent = 'Deploy Now & Generate QR';
                }
            });
        }
    </script>
</body>
</html>